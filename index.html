<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="apple-touch-fullscreen" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
<meta http-equiv="x-rim-auto-match" content="none" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-control" content="no-cache">
<title></title>
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/css.css">
<script src="js/jquery-3.4.1.min.js"></script> 
<script src="js/bootstrap.min.js"></script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="text-center mb-4">üé¨ Mis Pel√≠culas del Mes</h1>

    <!-- Formulario -->
    <form id="movieForm" class="card p-3 shadow-sm mb-4">
      <div class="mb-3">
        <label for="movieName" class="form-label">Pel√≠cula</label>
        <input type="text" id="movieName" class="form-control" required>
      </div>
      <div class="mb-3">
        <label for="movieRating" class="form-label">Puntuaci√≥n (1-10)</label>
        <input type="number" id="movieRating" class="form-control" min="1" max="10" required>
      </div>
      <button class="btn btn-primary w-100" type="submit">Guardar</button>
    </form>

    <h3>üìã Lista de Pel√≠culas</h3>
    <ul id="movieList" class="list-group"></ul>
  </div>

  <script>
    // üëâ Tu endpoint de Netlify (funci√≥n proxy)
    const endpoint = "/.netlify/functions/proxy";

    const form = document.getElementById('movieForm');
    const list = document.getElementById('movieList');

    // üîπ Cargar pel√≠culas desde Google Sheets
    async function cargarPeliculas() {
      list.innerHTML = "<li class='list-group-item'>Cargando...</li>";

      try {
        const res = await fetch(endpoint);
        const result = await res.json();
        console.log("üîé Datos recibidos:", result);

        const data = result.data || []; // accede al array real dentro del objeto
        list.innerHTML = '';

        if (!Array.isArray(data) || !data.length) {
          list.innerHTML = "<li class='list-group-item text-muted'>No hay pel√≠culas guardadas</li>";
          return;
        }

        // Mostrar las pel√≠culas en orden inverso (√∫ltimas primero)
        data.slice(1).reverse().forEach(p => {
          const pelicula = p.Pel√≠cula || "Sin t√≠tulo";
          const puntuacion = p.Puntuaci√≥n || "?";
          const fecha = p.Fecha ? new Date(p.Fecha).toLocaleDateString() : "";

          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <span><strong>${pelicula}</strong> ‚Äî ‚≠ê ${puntuacion}</span>
            <small class="text-muted">${fecha}</small>
          `;
          list.appendChild(li);
        });

      } catch (err) {
        list.innerHTML = "<li class='list-group-item text-danger'>‚ö†Ô∏è No se pudieron cargar las pel√≠culas</li>";
        console.error(err);
      }
    }

    // üîπ Guardar nueva pel√≠cula
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const pelicula = document.getElementById('movieName').value.trim();
      const puntuacion = document.getElementById('movieRating').value;

      if (!pelicula) return alert("Por favor escribe un nombre de pel√≠cula.");

      try {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pelicula, puntuacion })
        });

        form.reset();
        alert("‚úÖ Pel√≠cula guardada correctamente!");
        await cargarPeliculas();
      } catch (err) {
        alert("‚ö†Ô∏è Error al guardar la pel√≠cula");
        console.error(err);
      }
    });

    // Inicializar al cargar
    cargarPeliculas();
  </script>
</body></html>
