<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="apple-touch-fullscreen" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
<meta http-equiv="x-rim-auto-match" content="none" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-control" content="no-cache">
<title></title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/css.css">
<script src="js/jquery-3.4.1.min.js"></script> 
<script src="js/bootstrap.min.js"></script>
</head>
<body class="bg-body raleway">
<div class="container">
	<p class="text-center"><img src="img/logo.png" class="res_img" width="180"></p>
	
	<!-- Formulario -->
	<form id="movieForm" class="card p-3 shadow-sm mb-4">
		<div class="mb-3">
			<label for="movieName" class="form-label mb-1">Pel√≠cula</label>
			<input type="text" id="movieName" class="form-control" required>
		</div>
		<div class="mb-3">
			<label for="movieRating" class="form-label mb-1">Puntuaci√≥n (1-10)</label>
			<input type="number" id="movieRating" class="form-control" min="1" max="10" step="0.01" required>
		</div>
		<div class="mb-3">
			<label for="movieUser" class="form-label mb-1">Nombre</label>
			<input type="text" id="movieUser" class="form-control" placeholder="Ej. Laura" required>
		</div>
		<p class="text-center"><button class="btn bg-boton" style="width:150px" type="submit">Guardar</button></p>
	</form>
<h4>üéûÔ∏è Lista de Pel√≠culas</h4>
<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle text-center" id="movieTable">
    <thead class="table-primary">
      <tr>
        <th>üé¨ Pel√≠cula</th>
        <th>‚≠ê Puntuaci√≥n</th>
        <th>üë§ Usuario</th>
        <th>üìÖ Fecha</th>
      </tr>
    </thead>
    <tbody id="movieList"></tbody>
  </table>
</div>
</div>
<script>
    // üëâ Tu endpoint de Netlify (funci√≥n proxy)
    const endpoint = "/.netlify/functions/proxy";

    const form = document.getElementById('movieForm');
    const list = document.getElementById('movieList');

// üîπ Cargar pel√≠culas desde Google Sheets
async function cargarPeliculas() {
  const list = document.getElementById('movieList');
  list.innerHTML = "<tr><td colspan='4'>Cargando...</td></tr>";

  try {
    const res = await fetch(endpoint);
    const result = await res.json();
    console.log("üîé Datos recibidos:", result);

    const data = result.data || [];
    list.innerHTML = '';

    if (!Array.isArray(data) || data.length <= 1) {
      list.innerHTML = "<tr><td colspan='4' class='text-muted'>No hay pel√≠culas guardadas</td></tr>";
      return;
    }

    // Mostrar las pel√≠culas en orden inverso (√∫ltimas primero)
    data.slice(1).reverse().forEach(p => {
      const pelicula = p.Pel√≠cula || "Sin t√≠tulo";
      const puntuacion = parseFloat(p.Puntuaci√≥n || 0).toFixed(2);
      const usuario = p.Usuario || "Sin usuario";
      const fecha = p.Fecha ? new Date(p.Fecha).toLocaleDateString() : "";

      const row = `
        <tr>
          <td class="text-start">${pelicula}</td>
          <td>${puntuacion}</td>
          <td>${usuario}</td>
          <td>${fecha}</td>
        </tr>
      `;
      list.insertAdjacentHTML('beforeend', row);
    });

  } catch (err) {
    list.innerHTML = "<tr><td colspan='4' class='text-danger'>‚ö†Ô∏è No se pudieron cargar las pel√≠culas</td></tr>";
    console.error(err);
  }
}

    // üîπ Guardar nueva pel√≠cula
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const pelicula = document.getElementById('movieName').value.trim();
      const puntuacion = parseFloat(document.getElementById('movieRating').value).toFixed(2);
			const usuario = document.getElementById('movieUser').value.trim(); // üëà nuevo campo

      if (!pelicula) return alert("Por favor escribe un nombre de pel√≠cula.");

      try {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pelicula, puntuacion,usuario })
        });

        form.reset();
        alert("‚úÖ Pel√≠cula guardada correctamente!");
        await cargarPeliculas();
      } catch (err) {
        alert("‚ö†Ô∏è Error al guardar la pel√≠cula");
        console.error(err);
      }
    });

    // Inicializar al cargar
    cargarPeliculas();
  </script>
</body>
</html>
