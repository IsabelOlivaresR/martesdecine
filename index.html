<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="apple-touch-fullscreen" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta name="HandheldFriendly" content="true" />
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
<meta http-equiv="x-rim-auto-match" content="none" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-control" content="no-cache">
<title></title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/css.css">
<script src="js/jquery-3.4.1.min.js"></script> 
<script src="js/bootstrap.min.js"></script>
</head>
<body class="bg-body raleway p-4">
<div class="container">
	<p class="text-center"><img src="img/logo.png" class="res_img" width="180"></p>
	
	<!-- Formulario -->
	<form id="movieForm" class="card p-3 shadow-sm mb-4">
		<div class="mb-3">
			<label for="movieName" class="form-label mb-1">Pel√≠cula</label>
			<input type="text" id="movieName" class="form-control" required>
		</div>
		<div class="mb-3">
			<label for="movieRating" class="form-label mb-1">Puntuaci√≥n (1-10)</label>
			<input type="number" id="movieRating" class="form-control" min="1" max="10" step="0.01" required>
		</div>
		<div class="mb-3">
			<label for="movieUser" class="form-label mb-1">Nombre</label>
			<input type="text" id="movieUser" class="form-control" placeholder="Ej. Laura" required>
		</div>
		<p class="text-center"><button class="btn bg-boton" style="width:150px" type="submit">Guardar</button></p>
	</form>
	<h4>üéûÔ∏è Lista de Pel√≠culas</h4>
	<ul id="movieList" class="list-group card">
	</ul>
</div>
<script>
    // üëâ Tu endpoint de Netlify (funci√≥n proxy)
    const endpoint = "/.netlify/functions/proxy";

    const form = document.getElementById('movieForm');
    const list = document.getElementById('movieList');

    // üîπ Cargar pel√≠culas desde Google Sheets
    async function cargarPeliculas() {
      list.innerHTML = "<li class='list-group-item'>Cargando...</li>";

      try {
        const res = await fetch(endpoint);
        const result = await res.json();
        console.log("üîé Datos recibidos:", result);

        const data = result.data || []; // accede al array real dentro del objeto
        list.innerHTML = '';

        if (!Array.isArray(data) || !data.length) {
          list.innerHTML = "<li class='list-group-item text-muted'>No hay pel√≠culas guardadas</li>";
          return;
        }

        // Mostrar las pel√≠culas en orden inverso (√∫ltimas primero)
        data.slice(1).reverse().forEach(p => {
          const pelicula = p.Pel√≠cula || "Sin t√≠tulo";
          const puntuacion = p.Puntuaci√≥n || "?";
					const usuario = p.Usuario || "No user";
          const fecha = p.Fecha ? new Date(p.Fecha).toLocaleDateString() : "";

          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <span><strong>${pelicula}</strong> ‚Äî ‚≠ê ${puntuacion}</span>
            <small class="text-muted">${usuario} - ${fecha}</small>
          `;
          list.appendChild(li);
        });

      } catch (err) {
        list.innerHTML = "<li class='list-group-item text-danger'>‚ö†Ô∏è No se pudieron cargar las pel√≠culas</li>";
        console.error(err);
      }
    }

    // üîπ Guardar nueva pel√≠cula
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const pelicula = document.getElementById('movieName').value.trim();
      const puntuacion = parseFloat(document.getElementById('movieRating').value).toFixed(2);
			const usuario = document.getElementById('movieUser').value.trim(); // üëà nuevo campo

      if (!pelicula) return alert("Por favor escribe un nombre de pel√≠cula.");

      try {
        await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pelicula, puntuacion,usuario })
        });

        form.reset();
        alert("‚úÖ Pel√≠cula guardada correctamente!");
        await cargarPeliculas();
      } catch (err) {
        alert("‚ö†Ô∏è Error al guardar la pel√≠cula");
        console.error(err);
      }
    });

    // Inicializar al cargar
    cargarPeliculas();
  </script>
</body>
</html>
